<!DOCTYPE html>
<html lang="en">
<head>
    <title>mpris-lan</title>
    <meta charset="utf-8">
    <script src="brython.min.js"></script>
    <script src="brython_stdlib.min.js"></script>
    <link rel="icon" href="file-earmark-music.svg" type="image/svg+xml">
    <link rel="stylesheet" href="style.css">
</head>
<body onload="brython(0)">
    <noscript>
        <p style = "margin: 20px; font-size: 20px; color: black;">JavaScript is required to use this website.</p>
    </noscript>
    <script type="text/python">
        from browser import ajax, document, window

        for i in document.select ("#app *"):
            i.attrs ["draggable"] = "false"
        selected = set ()
        last_poll = {"__timestamp__": 0, "players": []}
        poll_id, thumb_id, range_id, scroll_id = -1, -1, -1, -1 # Invalid interval IDs
        next_range_update = True

        range_update_delay = 500  # ms
        thumb_freq = 3000         # ms
        scroll_freq = 25          # ms
        scroll_delta = 0.25       # --pc
        scroll_pause = 80         # times scroll_freq in ms
        range_debounce = 100      # ms

        def thumb_complete (res):
            for i in document.select ("[mpris-player]"):
                i.getElementsByClassName ("thumbnail") [0].src = res.json.get (i.attrs ["mpris-player"], "file-earmark-music.svg")

        def set_thumb ():
            ajax.get ("/thumbnail", oncomplete = thumb_complete, cache = True)

        def text_scroll ():
            global scroll_delta, scroll_pause
            for i in document.select ("[scroll-pause]"):
                overflow = i.scrollWidth - i.clientWidth
                if overflow <= 0:
                    i.style.right = "0px"
                    continue
                offset = float (i.style.right [ : -2])
                pause = int (i.attrs.get ("scroll-pause", "0"))
                if pause > 0:
                    if pause == 1 and offset > 0:
                        i.style.right = "0px"
                        i.attrs ["scroll-pause"] = str (scroll_pause)
                        continue
                    i.attrs ["scroll-pause"] = str (pause - 1)
                    continue
                # overflow > 0, pause == 0
                if offset >= overflow:
                    i.style.right = f"{overflow:.4f}px"
                    i.attrs ["scroll-pause"] = str (scroll_pause)
                else:
                    i.style.right = f"{(offset + document ["app"].clientWidth / 100 * scroll_delta):.4f}px"

        def format_time (time):
            seconds = int (time)
            if seconds < 3600:
                return f"{seconds // 60}:{(seconds % 60):02}"
            else:
                return f"{seconds // 3600}:{(seconds // 60) % 60:02}:{(seconds % 60):02}"

        def get_poll ():
            ajax.get ("/mpris", oncomplete = poll, cache = True)

        def restart_poll ():
            global poll_freq, poll_id
            window.clearTimeout (poll_id)
            poll_id = window.setTimeout (get_poll, 0)

        def restart_thumb ():
            global thumb_freq, thumb_id
            window.clearInterval (thumb_id)
            window.setTimeout (set_thumb, 0)
            thumb_id = window.setInterval (set_thumb, thumb_freq)

        def start_thumb_scroll ():
            global thumb_freq, thumb_id, scroll_freq, scroll_id
            if thumb_id == -1:
                window.setTimeout (set_thumb, 0)
                thumb_id = window.setInterval (set_thumb, thumb_freq)
            if scroll_id == -1:
                window.setTimeout (text_scroll, 0)
                scroll_id = window.setInterval (text_scroll, scroll_freq)

        def range_down (ev):
            ev.stopPropagation ()
            ev.target.attrs ["is-dragging"] = "true"

        def range_up (ev):
            ev.stopPropagation ()
            click (ev)
            if "is-dragging" in ev.target.attrs:
                del ev.target.attrs ["is-dragging"]

        def last_poll_player (playerInstance):
            global last_poll
            return (p for p in last_poll ["players"] if p ["playerInstance"] == playerInstance)

        def range_input (ev):
            global last_poll
            ev.stopPropagation ()
            playerEl = ev.target.closest (".player")
            for i in last_poll_player (playerEl.attrs.get ("mpris-player")):
                playerEl.getElementsByClassName ("pos-current") [0].textContent = format_time (float (ev.target.value) * float (i ["length"]))

        def num_players (num):
            curr_num = len (document.getElementsByClassName ("player"))
            if curr_num > num:
                for i in range (curr_num - num):
                    document.getElementsByClassName ("player") [-1].remove ()
            elif curr_num < num:
                for i in range (num - curr_num):
                    el = document ["template"].cloneNode (True)
                    el.classList.add ("player")
                    el.bind ("click", click)
                    for j in el.select ("input[type='range']"):
                        j.bind ("pointerdown", range_down)
                        j.bind ("pointerup", range_up)
                        j.bind ("input", range_input)
                    del el.attrs ["id"]
                    document.getElementById ("app").appendChild (el)

        def click (ev, delayed = False):
            global selected, last_poll, next_range_update, poll_id
            ev.stopPropagation ()
            playerEl = ev.target.closest (".player")
            playerInstance = playerEl.attrs.get ("mpris-player")
            if playerInstance is None:
                return
            el = ev.target
            cmd = {
                "players": list (selected.union ({playerInstance})),
            }
            if el.attrs.get ("mpris-cmd") is None:
                return
            cmd ["command"] = el.attrs ["mpris-cmd"]
            if el.attrs.get ("mpris-val"):
                cmd ["value"] = el.attrs ["mpris-val"]
            elif el.attrs.get ("mpris-action"):
                player = next (last_poll_player (playerInstance), None)
                if player is None:
                    return
                cmd ["players"] = [playerInstance] # Actions can only be applied to one player
                def rewind_forward_estimate (value):
                    playerEl.getElementsByClassName ("pos-current") [0].textContent = format_time (value)
                    playerEl.getElementsByClassName ("position-range") [0].value = value / float (player ["length"])
                    player ["position"] = value
                if el.attrs ["mpris-action"] == "rewind":
                    cmd ["value"] = max (float (player ["position"]) - 10, 0)
                    rewind_forward_estimate (cmd ["value"])
                elif el.attrs ["mpris-action"] == "forward":
                    cmd ["value"] = min (float (player ["position"]) + 10, player ["length"])
                    rewind_forward_estimate (cmd ["value"])
                elif el.attrs ["mpris-action"] == "seek":
                    global range_debounce, range_id
                    if not delayed:
                        if range_id != -1:
                            window.clearTimeout (range_id)
                            range_id, cleared = -1, True
                        else:
                            cleared = False
                        if ev.type == "pointerup":
                            range_id = window.setTimeout (lambda: click (ev, True), range_debounce)
                            if not cleared:
                                return
                    else:
                        range_id = -1
                    cmd ["value"] = float (el.value) * float (player ["length"])
                else:
                    return
            window.clearTimeout (poll_id)
            next_range_update = False
            req = ajax.Ajax ()
            req.bind ("complete", poll)
            req.open ("POST", "/mpris", True)
            req.set_header ("Content-Type", "application/json")
            req.send (window.JSON.stringify (cmd))

        def poll (res):
            global last_poll, next_range_update, thumb_id, poll_id, range_id, scroll_id, range_update_delay
            window.clearTimeout (poll_id)
            if not res.json:
                if len (document.select ("[mpris-player]")):
                    window.clearInterval (thumb_id)
                    window.clearInterval (scroll_id)
                    thumb_id, scroll_id = -1, -1
                    num_players (0)
                num_players (1)
                return
            elif "error" in res.json:
                window.console.error (res.json ["error"])
                return
            elif res.json ["__timestamp__"] <= last_poll ["__timestamp__"]:
                window.console.warn ("Poll received out of order")
                return
            start_thumb_scroll ()
            players = res.json ["players"]
            if len (players) != len (last_poll ["players"]) or any (
                (i ["title"], i ["artist"], i ["album"]) != (j ["title"], j ["artist"], j ["album"]) for i, j in zip (players, last_poll ["players"])):
                restart_thumb () # Thumbnails have likely changed if these fields have changed
            old_positions = {p ["playerInstance"]: p ["position"] for p in last_poll ["players"]}
            last_poll = res.json
            if not next_range_update:
                for p in last_poll ["players"]:
                    p ["position"] = old_positions.get (p ["playerInstance"], p ["position"])
            num_players (len (players))
            positions = []
            for p, el in zip (players, document.getElementsByClassName ("player")):
                el.attrs ["mpris-player"] = p ["playerInstance"]
                select = lambda x: el.querySelector (x)
                default = lambda key: p [key] or "N/A"
                def choose (opts, key, default = "x-circle-fill.svg"):
                    return opts.get (p [key].lower (), default)
                select ("[mpris-cmd='play-pause']").src = choose ({
                    "playing": "pause-fill.svg",
                    "paused": "play-fill.svg"
                }, "status")
                select ("[mpris-cmd='loop']").src = choose ({
                    "none": "x-circle-fill.svg",
                    "track": "repeat-1.svg",
                    "playlist": "repeat.svg"
                }, "loop")
                select ("[mpris-cmd='loop']").attrs ["mpris-val"] = choose ({
                    "none": "playlist",
                    "track": "none",
                    "playlist": "track"
                }, "loop", "playlist")
                select ("[mpris-cmd='shuffle']").src = choose ({
                    "false": "x-circle-fill.svg",
                    "true": "shuffle.svg"
                }, "shuffle")
                select (".pos-total").textContent = format_time (p ["length"])
                if next_range_update and range_id == -1 and select ("input[mpris-cmd='position']").attrs.get ("is-dragging") is None:
                    select ("input[mpris-cmd='position']").value = p ["position"] / p ["length"] if p ["length"] > 0 else 0
                    select (".pos-current").textContent = format_time (p ["position"])
                artist = " - ".join (filter (None, [p ["artist"], p ["album"]])) # artist - album / artist / album
                select (".artist").textContent = artist or p ["playerInstance"] or "N/A"
                select (".title").textContent = default ("title")
                if p ["status"] == "Playing":
                    positions.append (float (p ["position"]))

            if not next_range_update:
                next_range_update = True
                poll_id = window.setTimeout (get_poll, range_update_delay)
                return
            if positions:
                positions = sorted (i - int (i) for i in positions)
                max_gap = (0, 0)
                for i, j in zip (positions, positions [1 : ] + [positions [0] + 1]):
                    gap = j - i
                    if gap > max_gap [1]:
                        max_gap = (i, gap)
                delta = (1.5 - (max_gap [0] + max_gap [1] / 2)) % 1 + 0.5 # [0.5, 1.5) seconds
                poll_id = window.setTimeout (get_poll, delta * 1000)
            elif "toggle-on.svg" in document ["enable"].src:
                poll_id = window.setTimeout (get_poll, 1000)

        def site_disable ():
            global next_range_update, poll_id, scroll_id, thumb_id, selected
            window.clearTimeout (poll_id)
            window.clearInterval (scroll_id)
            window.clearInterval (thumb_id)
            poll_id, scroll_id, thumb_id, selected = -1, -1, -1, set ()
            next_range_update = True
            num_players (0)
            num_players (1)
            document ["enable"].src = "toggle-off.svg"

        def site_enable ():
            restart_poll ()
            start_thumb_scroll ()
            document ["enable"].src = "toggle-on.svg"

        document ["enable"].bind ("click", lambda ev: site_enable () if "toggle-off.svg" in ev.target.src else site_disable ())
        document.bind ("visibilitychange", lambda ev: site_disable () if document.hidden else site_enable ())   
        restart_poll ()
    </script>
    <div id="app">
        <div class="row-item">
            <div class="row">
                <input type="checkbox" id="checkbox" />
                <h1 id="title">mpris-lan</h1>
                <img class="icon" src="toggle-on.svg" id="enable">
            </div>
        </div>
        <div class="row-item" id="template">
            <div class="row">
                <div class="col">
                    <input type="checkbox" id="checkbox2" />
                    <img class="icon" mpris-cmd="stop" src="trash3-fill.svg">
                </div>
                <img class="thumbnail" src="file-earmark-music.svg">
                <div class="col">
                    <div class="row">
                        <img class="icon" mpris-cmd="previous" src="skip-backward-fill.svg">
                        <img class="icon" mpris-cmd="play-pause" src="x-circle-fill.svg">
                        <img class="icon" mpris-cmd="next" src="skip-forward-fill.svg">
                    </div>
                    <div class="row">
                        <img class="icon" mpris-cmd="loop" mpris-val="playlist" src="x-circle-fill.svg">
                        <div class="col">
                            <p class="annotation">&lt;- Loop</p>
                            <p class="annotation">Shuffle -></p>
                        </div>
                        <img class="icon" mpris-cmd="shuffle" mpris-val="toggle" src="x-circle-fill.svg">
                    </div>
                </div>
            </div>
            <div class="row">
                <img class="icon" mpris-cmd="position" mpris-action="rewind" src="rewind-fill.svg">
                <input class="position-range" type="range" min="0" max="1" value="0.5" step="any" mpris-cmd="position" mpris-action="seek" />
                <img class="icon" mpris-cmd="position" mpris-action="forward" src="fast-forward-fill.svg">
            </div>
            <div class="row">
                <p class="position pos-current">0:00</p>
                <div class="text-scroll artist-scroll">
                    <p class="artist" style="right: 0px;" scroll-pause="0">Artist</p>
                </div>
                <p class="position pos-total">0:00</p>
            </div>
            <div class="row">
                <div class="text-scroll">
                    <p class="title" style="right: 0px;" scroll-pause="0">Title</p>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
